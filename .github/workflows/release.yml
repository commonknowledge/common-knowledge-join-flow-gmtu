name: Release

on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    # Skip if the push was a version bump commit from this workflow
    if: "!contains(github.event.head_commit.message, '[release]')"

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current version
        id: version
        run: |
          CURRENT=$(grep -oP "Version:\s+\K[0-9]+\.[0-9]+\.[0-9]+" join-gmtu.php)
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          PATCH=$((PATCH + 1))
          NEW="$MAJOR.$MINOR.$PATCH"
          echo "new=$NEW" >> "$GITHUB_OUTPUT"

      - name: Bump version in plugin header
        run: |
          sed -i "s/Version:         ${{ steps.version.outputs.current }}/Version:         ${{ steps.version.outputs.new }}/" join-gmtu.php

      - name: Bump version in composer.json
        run: |
          sed -i 's/"version": "${{ steps.version.outputs.current }}"/"version": "${{ steps.version.outputs.new }}"/' composer.json

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add join-gmtu.php composer.json
          git commit -m "Bump version to ${{ steps.version.outputs.new }} [release]"
          git push

      - name: Create tag and release
        run: |
          TAG="v${{ steps.version.outputs.new }}"
          git tag "$TAG"
          git push origin "$TAG"
          gh release create "$TAG" \
            --title "$TAG" \
            --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
